
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DropMyEmail Blog</title>
  <meta name="author" content="DropMyEmail">

  
  <meta name="description" content="At DropMyEmail, we are evaluating open source private cloud storage solutions. We have found OpenStack Swift to be the best choice in the market &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://engineering.dropmyemail.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/blog/atom.xml" rel="alternate" title="DropMyEmail Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DropMyEmail Blog</a></h1>
  
    <h2>engineering blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:engineering.dropmyemail.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/24/how-to-install-openstack-swift-on-amazon-aws/">How to Install Openstack Swift on Amazon AWS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-24T12:19:00+08:00" pubdate data-updated="true">Jan 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At <a href="http://dropmyemail">DropMyEmail</a>, we are evaluating open source private cloud storage solutions. We have found <a href="http://swift.openstack.org">OpenStack Swift</a> to be the best choice in the market right now. We are documenting the steps to build a prototype swift cluster. Much of the work is from this amazing <a href="http://www.buildcloudstorage.com/2011/10/installing-openstack-swift-cluster-on.html">blog post by Amar</a> and the <a href="http://docs.openstack.org/developer/swift/howto_installmultinode.html">multiple server swift installation</a> document. Our setup is largely similar except that we are on a more recent stack.</p>

<h2>Overview</h2>

<p><img src="https://s3.amazonaws.com/static.engineering.dropmyemail.com/DropMyEmail+Prototype+OpenStack+Swift+Cluster.png" title="DropMyEmail Prototype OpenStack Swift Cluster" ></p>

<p>It is a simple architecture. We have a proxy server which acts as the interface for the outside world. The proxy server includes the authentication server. The proxy server is connected to 5 storage nodes. Each storage node includes account, container and object servers. Each node is a single <a href="http://aws.amazon.com/ec2">EC2</a> instance.</p>

<h2>Setting up the instances</h2>

<p>We assume you know how to set up an EC2 instance. Our instance are all <strong>Ubuntu Linux 12.04</strong> images from <a href="http://alestic.com">Alestic</a>.</p>

<p>For the security groups, here are the settings we used for each type of node.</p>

<h3>Security group</h3>

<ul>
<li>Port 22 from source 0.0.0.0/0</li>
<li>Port 43 from source 0.0.0.0/0</li>
<li>Port 6000-6100 from source 0.0.0.0/0</li>
</ul>


<p>For the rest of the article, we&#8217;ll be using the public and private IP addresses of the EC2 instance at different scenarios. Do note <a href="http://aws.amazon.com/articles/1145">the differences</a> betwen them. We&#8217;ll be assuming you are logging into the instance via ssh and running commands.</p>

<h2>Preparing the base Swift image</h2>

<p>We are going to prepare an <a href="https://aws.amazon.com/amis">AMI</a> image with the core Swift software installed.</p>

<p>First we add the swift repository and install the base swift packages.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo add-apt-repository ppa:swift-core/release
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install swift</span></code></pre></td></tr></table></div></figure>


<p>Next we set up the swift configuration files. Create the Swift configuration directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo mkdir -p /etc/swift</span></code></pre></td></tr></table></div></figure>


<p>We need to create a random string to act as the hash for Swift. Run the following command, you should see a random string as the result.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo od -t x8 -N 8 -A n &lt;/dev/random</span></code></pre></td></tr></table></div></figure>


<p>Create <strong>/etc/swift/swift.conf</strong>. Add the following lines to it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[swift-hash]
</span><span class='line'># random unique string that can never change (DO NOT LOSE)
</span><span class='line'>swift_hash_path_suffix = &lt;RESULTS FROM ABOVE od COMMAND&gt;</span></code></pre></td></tr></table></div></figure>


<p>Change the owner to swift.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo chown -R swift:swift /etc/swift</span></code></pre></td></tr></table></div></figure>


<p>Now save the image as an AMI. This base image can be used for the other instances.</p>

<h2>Setting up the Swift Proxy server</h2>

<p>Now choose one instance for the proxy server. The proxy server contains both the proxy and authentication server. Let us install the proxy server first.</p>

<p>Run these commands to install the dependencies.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install swift-proxy memcached swauth</span></code></pre></td></tr></table></div></figure>


<p>You could use <a href="http://keystone.openstack.org">OpenStack Keystone</a> for authentication. Cons is you need to set up and maintain another system for authentication. Swauth is a self-contained authentication server on the proxy server. If you just want to run Swift on its own, we&#8217;d recommend going with <a href="https://github.com/gholt/swauth">Swauth</a>.</p>

<p>Next we create the SSL cert to encrypt our requests.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /etc/swift
</span><span class='line'>sudo openssl req -new -x509 -nodes -out cert.crt -keyout cert.key</span></code></pre></td></tr></table></div></figure>


<p>We need to replace the IP address in the memcached configuration file and then restart memcached. Check the private IP address for the instance and replace the IP with your own. We are <em>assuming</em> it is <strong>10.0.0.0</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo export PROXY_LOCAL_NET_IP=10.0.0.0
</span><span class='line'>sudo perl -pi -e "s/-l 127.0.0.1/-l $PROXY_LOCAL_NET_IP/" /etc/memcached.conf
</span><span class='line'>sudo service memcached restart</span></code></pre></td></tr></table></div></figure>


<p>Next we need to create the configuration file for the proxy server. Create <strong>/etc/swift/proxy-server.conf</strong> with the following contents. Remember to replace the URL and IP address with those from your instance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>bind_port = 443
</span><span class='line'>cert_file = /etc/swift/cert.crt
</span><span class='line'>key_file = /etc/swift/cert.key
</span><span class='line'>workers = 8
</span><span class='line'>user = swift
</span><span class='line'>
</span><span class='line'>[pipeline:main]
</span><span class='line'>pipeline = healthcheck cache swauth proxy-server
</span><span class='line'>
</span><span class='line'>[app:proxy-server]
</span><span class='line'>use = egg:swift#proxy
</span><span class='line'>allow_account_management = true
</span><span class='line'>
</span><span class='line'>[filter:swauth]
</span><span class='line'>use = egg:swauth#swauth
</span><span class='line'>set log_name = swauth
</span><span class='line'>super_admin_key = swauthkey
</span><span class='line'>default_swift_cluster = cluster_name#https://ec2-1-2-3-4.compute-1.amazonaws.com:443/v1#https://127.0.0.1:443/v1
</span><span class='line'>
</span><span class='line'>[filter:healthcheck]
</span><span class='line'>use = egg:swift#healthcheck
</span><span class='line'>
</span><span class='line'>[filter:cache]
</span><span class='line'>use = egg:swift#memcache
</span><span class='line'>memcache_servers = 10.0.0.0:11211</span></code></pre></td></tr></table></div></figure>


<p>Now we create the rings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /etc/swift
</span><span class='line'>sudo swift-ring-builder account.builder create 18 3 1
</span><span class='line'>sudo swift-ring-builder container.builder create 18 3 1
</span><span class='line'>sudo swift-ring-builder object.builder create 18 3 1</span></code></pre></td></tr></table></div></figure>


<p>And set the owner back to swift.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo chown -R swift:swift /etc/swift</span></code></pre></td></tr></table></div></figure>


<p>This is it for now. We&#8217;ll set up the storage nodes first before coming back to the proxy server.</p>

<h2>Setting up the Swift Storage nodes</h2>

<p>Unlike what Amar proposed, there is no need to keep the instances under the same availability zone. Ideally the storage nodes should be in different regions to prevent multiple failures. For our case, we are setting up everything in the same region for convenience.</p>

<p>We are going to add EBS volumes to mimic hard drives. Create a new EBS volume for each storage server and attach them. You may use the default value of <strong>/dev/sdf</strong> for <strong>Device</strong>. They will be renamed to <strong>/dev/xvdf</strong> in your instance.</p>

<p>The storage node contain the account, container and object servers. Install the dependencies.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install swift-account swift-container swift-object xfsprogs</span></code></pre></td></tr></table></div></figure>


<p>Next we want to set up the partition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo fdisk /dev/xvdf</span></code></pre></td></tr></table></div></figure>


<p>FDisk will be prompt you for the values. You may follow the responses in order</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>n
</span><span class='line'>p
</span><span class='line'>1
</span><span class='line'>Enter
</span><span class='line'>Enter
</span><span class='line'>w</span></code></pre></td></tr></table></div></figure>


<p>Next we build the <a href="http://en.wikipedia.org/wiki/XFS">XFS</a> file system within the partition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo mkfs.xfs -i size=1024 /dev/xvdf1</span></code></pre></td></tr></table></div></figure>


<p>Append the following line to <strong>/etc/fstab</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/dev/xvdf1 /srv/node/xvdf1 xfs noatime,nodiratime,nobarrier,logbufs=8 0 0</span></code></pre></td></tr></table></div></figure>


<p>We mount it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo mkdir -p /srv/node/xvdf1
</span><span class='line'>sudo mount /srv/node/xvdf1</span></code></pre></td></tr></table></div></figure>


<p>And change the owner to swift.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo chown -R swift:swift /srv/node</span></code></pre></td></tr></table></div></figure>


<h3>Rsync</h3>

<p>We need to configure <a href="http://en.wikipedia.org/wiki/Rsync">rsync</a> as well. Create <strong>/etc/rsyncd.conf</strong>. Add the following to the file. <strong>STORAGE_LOCAL_NET_IP</strong> is the IP address of the instance. Change it accordingly.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>uid = swift
</span><span class='line'>gid = swift
</span><span class='line'>log file = /var/log/rsyncd.log
</span><span class='line'>pid file = /var/run/rsyncd.pid
</span><span class='line'>address = &lt;STORAGE_LOCAL_NET_IP&gt;
</span><span class='line'>
</span><span class='line'>[account]
</span><span class='line'>max connections = 2
</span><span class='line'>path = /srv/node/
</span><span class='line'>read only = false
</span><span class='line'>lock file = /var/lock/account.lock
</span><span class='line'>
</span><span class='line'>[container]
</span><span class='line'>max connections = 2
</span><span class='line'>path = /srv/node/
</span><span class='line'>read only = false
</span><span class='line'>lock file = /var/lock/container.lock
</span><span class='line'>
</span><span class='line'>[object]
</span><span class='line'>max connections = 2
</span><span class='line'>path = /srv/node/
</span><span class='line'>read only = false
</span><span class='line'>lock file = /var/lock/object.lock</span></code></pre></td></tr></table></div></figure>


<p>Enable rsync in the rsync configuration at <strong>/etc/default/rsync</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RSYNC_ENABLE = true</span></code></pre></td></tr></table></div></figure>


<p>And start rsync</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service rsync start</span></code></pre></td></tr></table></div></figure>


<h3>Account/Container/Object server configurations</h3>

<p>Next we need to set the IP address for the account, container and object server configuration files. Use the instance&#8217;s IP address for <strong>STORAGE_LOCAL_NET_IP</strong>.</p>

<p>The account server&#8217;s configuration file is at <strong>/etc/swift/account-server.conf</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>bind_ip = &lt;STORAGE_LOCAL_NET_IP&gt;
</span><span class='line'>workers = 2
</span><span class='line'>
</span><span class='line'>[pipeline:main]
</span><span class='line'>pipeline = account-server
</span><span class='line'>
</span><span class='line'>[app:account-server]
</span><span class='line'>use = egg:swift#account
</span><span class='line'>
</span><span class='line'>[account-replicator]
</span><span class='line'>
</span><span class='line'>[account-auditor]
</span><span class='line'>
</span><span class='line'>[account-reaper]</span></code></pre></td></tr></table></div></figure>


<p>The container server&#8217;s configuration file is at <strong>/etc/swift/container-server.conf</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>bind_ip = &lt;STORAGE_LOCAL_NET_IP&gt;
</span><span class='line'>workers = 2
</span><span class='line'>
</span><span class='line'>[pipeline:main]
</span><span class='line'>pipeline = container-server
</span><span class='line'>
</span><span class='line'>[app:container-server]
</span><span class='line'>use = egg:swift#container
</span><span class='line'>
</span><span class='line'>[container-replicator]
</span><span class='line'>
</span><span class='line'>[container-updater]
</span><span class='line'>
</span><span class='line'>[container-auditor]</span></code></pre></td></tr></table></div></figure>


<p>The object server&#8217;s configuration file is at <strong>/etc/swift/object-server.conf</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEFAULT]
</span><span class='line'>bind_ip = &lt;STORAGE_LOCAL_NET_IP&gt;
</span><span class='line'>workers = 2
</span><span class='line'>
</span><span class='line'>[pipeline:main]
</span><span class='line'>pipeline = object-server
</span><span class='line'>
</span><span class='line'>[app:object-server]
</span><span class='line'>use = egg:swift#object
</span><span class='line'>
</span><span class='line'>[object-replicator]
</span><span class='line'>
</span><span class='line'>[object-updater]
</span><span class='line'>
</span><span class='line'>[object-auditor]</span></code></pre></td></tr></table></div></figure>


<p>Repeat these steps for the rest of the storage nodes.</p>

<h2>Starting the servers</h2>

<p>Let&#8217;s go back to the proxy server. We are going to create a script to build the rings. Create a file at <strong>/etc/swift/build_rings.sh</strong>. Replace the IP address accordingly.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>export ZONE=1                  # set the zone number for that storage device
</span><span class='line'>export STORAGE_LOCAL_NET_IP=10.0.0.1   # and the IP address
</span><span class='line'>export WEIGHT=100               # relative weight (higher for bigger/faster disks)
</span><span class='line'>export DEVICE=sdf1
</span><span class='line'>sudo swift-ring-builder account.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6002/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder container.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6001/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder object.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6000/$DEVICE $WEIGHT
</span><span class='line'>
</span><span class='line'>export ZONE=2                  # set the zone number for that storage device
</span><span class='line'>export STORAGE_LOCAL_NET_IP=10.0.0.2   # and the IP address
</span><span class='line'>export WEIGHT=100               # relative weight (higher for bigger/faster disks
</span><span class='line'>export DEVICE=sdf1
</span><span class='line'>sudo swift-ring-builder account.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6002/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder container.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6001/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder object.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6000/$DEVICE $WEIGHT
</span><span class='line'>
</span><span class='line'>export ZONE=3                  # set the zone number for that storage device
</span><span class='line'>export STORAGE_LOCAL_NET_IP=10.0.0.3   # and the IP address
</span><span class='line'>export WEIGHT=100               # relative weight (higher for bigger/faster disks)
</span><span class='line'>export DEVICE=sdf1
</span><span class='line'>sudo swift-ring-builder account.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6002/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder container.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6001/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder object.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6000/$DEVICE $WEIGHT
</span><span class='line'>
</span><span class='line'>export ZONE=4                  # set the zone number for that storage device
</span><span class='line'>export STORAGE_LOCAL_NET_IP=10.0.0.4   # and the IP address
</span><span class='line'>export WEIGHT=100               # relative weight (higher for bigger/faster disks
</span><span class='line'>export DEVICE=sdf1
</span><span class='line'>sudo swift-ring-builder account.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6002/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder container.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6001/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder object.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6000/$DEVICE $WEIGHT
</span><span class='line'>
</span><span class='line'>export ZONE=5                  # set the zone number for that storage device
</span><span class='line'>export STORAGE_LOCAL_NET_IP=10.0.0.5   # and the IP address
</span><span class='line'>export WEIGHT=100               # relative weight (higher for bigger/faster disks
</span><span class='line'>export DEVICE=sdf1
</span><span class='line'>sudo swift-ring-builder account.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6002/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder container.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6001/$DEVICE $WEIGHT
</span><span class='line'>sudo swift-ring-builder object.builder add z$ZONE-$STORAGE_LOCAL_NET_IP:6000/$DEVICE $WEIGHT</span></code></pre></td></tr></table></div></figure>


<p>Make the script executable and run it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo chmod +x /etc/swift/build_rings.sh
</span><span class='line'>sudo /etc/swift/build_rings.sh</span></code></pre></td></tr></table></div></figure>


<p>We continue the build the rings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo swift-ring-builder account.builder
</span><span class='line'>sudo swift-ring-builder container.builder
</span><span class='line'>sudo swift-ring-builder object.builder</span></code></pre></td></tr></table></div></figure>


<p>And rebalance them.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo swift-ring-builder account.builder rebalance
</span><span class='line'>sudo swift-ring-builder container.builder rebalance
</span><span class='line'>sudo swift-ring-builder object.builder rebalance</span></code></pre></td></tr></table></div></figure>


<p>Copy your instance&#8217;s private key(the key file which you use for sshing in to your instance) to the proxy server. I&#8217;m assuming it is <strong>private_key.pem</strong>. Change the permission of <strong>private_key.pem</strong> to <strong>0600</strong>.</p>

<p>Next we need to propagate the ring files to all the storage nodes</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scp -i private_key.pem /etc/swift/*.gz ubuntu@10.0.0.1:/etc/swift
</span><span class='line'>scp -i private_key.pem /etc/swift/*.gz ubuntu@10.0.0.2:/etc/swift
</span><span class='line'>scp -i private_key.pem /etc/swift/*.gz ubuntu@10.0.0.3:/etc/swift
</span><span class='line'>scp -i private_key.pem /etc/swift/*.gz ubuntu@10.0.0.4:/etc/swift
</span><span class='line'>scp -i private_key.pem /etc/swift/*.gz ubuntu@10.0.0.5:/etc/swift</span></code></pre></td></tr></table></div></figure>


<p>Log in to each of the storage node and run these commands.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /etc/swift
</span><span class='line'>sudo chown -R swift:swift /etc/swift
</span><span class='line'>sudo swift-init all start</span></code></pre></td></tr></table></div></figure>


<p>Your storage node should be running!</p>

<p>Now we need to start the proxy server. Log into the proxy server and run these commands.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo chown -R swift:swift /etc/swift
</span><span class='line'>sudo swift-init proxy start</span></code></pre></td></tr></table></div></figure>


<h3>Setting the authentication</h3>

<p>We need to create the user for authentication.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo swauth-prep -K swauthkey -A https://127.0.0.1/auth/
</span><span class='line'>sudo swauth-add-user -K swauthkey -A https://127.0.0.1/auth/ -a test tester testing</span></code></pre></td></tr></table></div></figure>


<h2>Using the Swift cluster</h2>

<p>We have chosen to use another EC2 instance to act as a Swift client. As usual, create an instance and run the following commands.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo add-apt-repository ppa:swift-core/release
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install swift</span></code></pre></td></tr></table></div></figure>


<p>We need to obtain the authentication token first. As usual, replace the url with your own.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k -v -H 'X-Storage-User: test:tester' -H 'X-Storage-Pass: testing' https://ec2-1-2-3-4.compute-1.amazonaws.com/auth/v1.0</span></code></pre></td></tr></table></div></figure>


<p>You should get this output</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* About to connect() to ec2-1-2-3-4.compute-1.amazonaws.com port 443 (#0)
</span><span class='line'>*   Trying 10.0.0.1... connected
</span><span class='line'>* successfully set certificate verify locations:
</span><span class='line'>*   CAfile: none
</span><span class='line'>  CApath: /etc/ssl/certs
</span><span class='line'>* SSLv3, TLS handshake, Client hello (1):
</span><span class='line'>* SSLv3, TLS handshake, Server hello (2):
</span><span class='line'>* SSLv3, TLS handshake, CERT (11):
</span><span class='line'>* SSLv3, TLS handshake, Server finished (14):
</span><span class='line'>* SSLv3, TLS handshake, Client key exchange (16):
</span><span class='line'>* SSLv3, TLS change cipher, Client hello (1):
</span><span class='line'>* SSLv3, TLS handshake, Finished (20):
</span><span class='line'>* SSLv3, TLS change cipher, Client hello (1):
</span><span class='line'>* SSLv3, TLS handshake, Finished (20):
</span><span class='line'>* SSL connection using AES256-SHA
</span><span class='line'>* Server certificate:
</span><span class='line'>*        subject: C=AU; ST=Some-State; O=Internet Widgits Pty Ltd
</span><span class='line'>*        start date: 2013-01-23 06:24:57 GMT
</span><span class='line'>*        expire date: 2013-02-22 06:24:57 GMT
</span><span class='line'>* SSL: unable to obtain common name from peer certificate
</span><span class='line'>&gt; GET /auth/v1.0 HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3
</span><span class='line'>&gt; Host: ec2-1-2-3-4.compute-1.amazonaws.com
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt; X-Storage-User: test:tester
</span><span class='line'>&gt; X-Storage-Pass: testing
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 200 OK
</span><span class='line'>&lt; X-Storage-Url: https://ec2-1-2-3-4.compute-1.amazonaws.com:443/v1/AUTH_f1e9d209-4543-4907-8ae3-98f24e0b051f
</span><span class='line'>&lt; X-Storage-Token: AUTH_tkd26a954e86534b9498f1b196fdb60ac2
</span><span class='line'>&lt; X-Auth-Token: AUTH_tkd26a954e86534b9498f1b196fdb60ac2
</span><span class='line'>&lt; Content-Length: 155
</span><span class='line'>&lt; Date: Thu, 24 Jan 2013 03:59:09 GMT
</span><span class='line'>&lt;
</span><span class='line'>* Connection #0 to host ec2-1-2-3-4.compute-1.amazonaws.com left intact
</span><span class='line'>* Closing connection #0
</span><span class='line'>* SSLv3, TLS alert, Client hello (1):
</span><span class='line'>{"storage": {"cluster_name": "https://ec2-1-2-3-4.compute-1.amazonaws.com:443/v1/AUTH_f1e9d209-4543-4907-8ae3-98f24e0b051f", "default": "cluster_name"}}</span></code></pre></td></tr></table></div></figure>


<p>Next we make a request with the authentication token.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k -v -H 'X-Auth-Token: AUTH_tkd26a954e86534b9498f1b196fdb60ac2' https://ec2-184-73-4-50.compute-1.amazonaws.com:443/v1/AUTH_f1e9d209-4543-4907-8ae3-98f24e0b051f</span></code></pre></td></tr></table></div></figure>


<p>You should get this output.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* About to connect() to ec2-1-2-3-4.compute-1.amazonaws.com port 443 (#0)
</span><span class='line'>*   Trying 10.0.0.1... connected
</span><span class='line'>* successfully set certificate verify locations:
</span><span class='line'>*   CAfile: none
</span><span class='line'>  CApath: /etc/ssl/certs
</span><span class='line'>* SSLv3, TLS handshake, Client hello (1):
</span><span class='line'>* SSLv3, TLS handshake, Server hello (2):
</span><span class='line'>* SSLv3, TLS handshake, CERT (11):
</span><span class='line'>* SSLv3, TLS handshake, Server finished (14):
</span><span class='line'>* SSLv3, TLS handshake, Client key exchange (16):
</span><span class='line'>* SSLv3, TLS change cipher, Client hello (1):
</span><span class='line'>* SSLv3, TLS handshake, Finished (20):
</span><span class='line'>* SSLv3, TLS change cipher, Client hello (1):
</span><span class='line'>* SSLv3, TLS handshake, Finished (20):
</span><span class='line'>* SSL connection using AES256-SHA
</span><span class='line'>* Server certificate:
</span><span class='line'>*        subject: C=AU; ST=Some-State; O=Internet Widgits Pty Ltd
</span><span class='line'>*        start date: 2013-01-23 06:24:57 GMT
</span><span class='line'>*        expire date: 2013-02-22 06:24:57 GMT
</span><span class='line'>* SSL: unable to obtain common name from peer certificate
</span><span class='line'>&gt; GET /v1/AUTH_f1e9d209-4543-4907-8ae3-98f24e0b051f HTTP/1.1
</span><span class='line'>&gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3
</span><span class='line'>&gt; Host: ec2-1-2-3-4.compute-1.amazonaws.com
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt; X-Auth-Token: AUTH_tkd26a954e86534b9498f1b196fdb60ac2
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 204 No Content
</span><span class='line'>&lt; X-Account-Object-Count: 0
</span><span class='line'>&lt; X-Account-Bytes-Used: 0
</span><span class='line'>&lt; X-Account-Container-Count: 0
</span><span class='line'>&lt; Accept-Ranges: bytes
</span><span class='line'>&lt; Content-Length: 0
</span><span class='line'>&lt; Date: Thu, 24 Jan 2013 04:00:47 GMT
</span><span class='line'>&lt;
</span><span class='line'>* Connection #0 to host ec2-1-2-3-4.compute-1.amazonaws.com left intact
</span><span class='line'>* Closing connection #0
</span><span class='line'>* SSLv3, TLS alert, Client hello (1):</span></code></pre></td></tr></table></div></figure>


<p>Now we are able to use our Swift store. The <strong>stat</strong> command shows you what is on the server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>swift -A https://ec2-1-2-3-4.compute-1.amazonaws.com/auth/v1.0 -U test:tester -K testing stat</span></code></pre></td></tr></table></div></figure>


<p>Have a look at the options available with the help option.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>swift -h</span></code></pre></td></tr></table></div></figure>


<p>Try uploading a file with the <strong>upload</strong> command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>swift -A https://ec2-1-2-3-4.compute-1.amazonaws.com/auth/v1.0 -U test1:tester1 -K testing upload test foo.gz</span></code></pre></td></tr></table></div></figure>


<p>And there you go, a working swift cluster. Please let us know if there are any mistakes. Thanks!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/24/how-to-install-openstack-swift-on-amazon-aws/">How to install Openstack Swift on Amazon AWS</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - DropMyEmail -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
